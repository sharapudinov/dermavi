# Bitrix Skeleton

## Вступление

Bitrix Skeleton - современный скелет для нового проекта на базе 1С-Битрикс.

Он предлагает разработчику готовую архитектуру, в которой очень многие решения уже приняты.

Основные задачи:
1. Уменьшить время требуемое на разработку и поддержку проекта.
2. Помочь разработчику писать качественный и современный код.
3. Стандартизировать проекты, что поможет разработчикам проще переключаться между ними.
4. Сделать разработку удобной и интересной.

## Системные требования

1. Сервер с Linux
2. php не ниже 7.0
3. nginx + php-fpm (в крайнем случае nginx + apache2)
4. Глобально установленный composer

## Установка (Разворот stage сервера для нового проекта)

Первым делом нужно развернуть сам Битрикс в нужной редакции (нужны папки bitrix upload и база)
Если не используется сервер-заготовка, то как вы их получите - ваше дело.

Если же используется, то делается это следующим образом:
1. Заходим на http://52.93.111.109/setup/bitrixsetup.php где 52.93.111.109 - IP свежеразвернутого сервера из заготовки
2. Выбираем нужную редакцию (стоит уточнить у менеджера какую)
3. Обязательно выбираем utf-8
4. Создаем новую базу (root : ohe-astr4f), Тип таблиц базы данных обязательно выбрать InnoDB, права доступа к файлам ставим 0775
5. Создаем администратора с логином greensight и паролем оттуда http://www.onlinepasswordgenerator.ru/
6. Выбираем "Демо-сайт для разработчиков -> Корпоративный сайт"
7. В названии сайта пишем название проекта (например leroymerlin.kz), слоган очищаем
8. На последнем шаге снимаем все чекбоксы у инфоблоков, примеров и всего остального

Готово, теперь можно приступать к развороту собственно скелетона.
Далее будем считать что проект называется mysite, вам нужно будет везде заменять mysite на название вашего проекта
1. Создаем директорию `mkdir /var/www/mysite.ru`
2. Помещаем в неё директории `bitrix` и `upload` т.е ядро битрикса. Если вы не устанавливали базу на этом сервере, то её также нужно загрузить и проимпортировать в mysql
3. Также создаем на сервере БД Битрикса.
4. `cd /var/www/mysite.ru && git clone git@gitlab.com:greensight/bitrix-skeleton.git master.mysite.greensight.ru`
5. Устанавливаем composer если он еще не установлен https://getcomposer.org/download/. Наберите в консоли composer, чтобы убедиться что он установился. Должно вывести список команд
6. `sudo service mysql stop && cd master.mysite.greensight.ru && sudo chmod +x install/run.sh && ./install/run.sh && sudo service mysql start`
7. Прописываем нужные реквизиты базы данных и APP_URL в `/var/www/mysite.ru/.env.php`
8. Настраиваем виртуальные сервера nginx и apache2/php-fpm для директории /var/www/mysite.ru/master.mysite.greensight.ru/public. Если вы делаете это на сервере шаблоне(скорее всего), то смотрите как это делать [(тут)](https://docs.google.com/a/greensight.ru/document/d/1aeotECPWd-qbBsMpAKL4TGJpGf4EBxaNWxnFJQXfEFY/edit?usp=sharing). Если же нет, то вот [(пример конфига nginx для php7.1-fpm)](https://gitlab.com/greensight/bitrix-skeleton/blob/master/install/examples/stage_nginx.conf)
9. Создаем новый репозиторий в директории `/var/www/mysite.ru/master.mysite.greensight.ru`, либо копируем туда папку .git если репозиторий уже есть и не пустой. Во втором случае также нужно залить вручную все файлы из репы (обычно это верстка)
10. Копируем хуки скелетона в новую папку .git -  `cp -R install/src/hooks .git/ && sudo chmod -R +x .git/hooks/`
11. Заходим в редактирование сайта (/bitrix/admin/site_edit.php?lang=ru&LID=s1) и меняем шаблон на с Битриксового на "Основной шаблон" чтобы было вот так [(https://i.gyazo.com/0b9824571602e52249865e5fb859e4ab.png)](https://i.gyazo.com/0b9824571602e52249865e5fb859e4ab.png)
12. Переводим агентов на крон (см ниже)
13. Обновляем вики проекта

## Перевод агентов на крон

1. Заходим на /bitrix/admin/php_command_line.php?lang=ru и выполняем:
```
COption::SetOptionString("main", "agents_use_crontab", "N");
COption::SetOptionString("main", "check_agents", "N");
COption::SetOptionString("main", "mail_event_bulk", "20");
```
2. На боевом добавляем в кронтаб задание:
`*/5 * * * * /usr/bin/php -f /var/www/<path>/app/cron/bitrix_cron_events.php`
Добавлять ли на тестовои - вопрос дискуссионный.

## Структура скелета

Итак, в `/var/www/mysite.ru/` находятся три директории
1. `master.mysite.greensight.ru` - главная stage площадка, в которой у нас собственно находится репозиторий и весь остальной проект.
Она соответсвует домену `master.mysite.greensight.ru`
В будущем при небходимости рядом с ней могут быть добавлены дополнительные площадки, например `dev1`, `dev2` и т д.
2. `bitrix` - общее ядро Битрикса для всех площадок
3. `upload` - общий upload для всех площадок

Нас по сути интересует только директория master.mysite.greensight.ru. То что в неё находится - наш проект.
Она является корнем репозиторий, но не DOCUMENT_ROOT веб-сервера.

### Основные директории:

1. `public` - директория доступная через веб-сервер (DOCUMENT_ROOT). В ней некоторое подмножество файлов которое ставит Битрикс при своей установки и симлинки на local и bitrix, а также симлинк html на ../html/build - там лежит фронтэнд
Также там есть две новые важные поддирректории.
   1. `assets` - место для фронтэнда. В `assets/build` собирается production сборка.
   2. `api` - входная точка для API сайта. Об API мы поговорим ниже. 
2. `html` - место где лежит dev сборка фронтэнда. Посмотреть через браузер файлы оттуда можно следующим образом `html/build/ui_kit.html` ->  `https://master.mysite.greensight.ru/html/ui_kit.html` То есть всё что лежит в html/build/.. доступно в браузере по /html/..
3. `app` - директория в которой будет находится подавляющее большинство кода написанного при разработке проекта. Ей будет посвящен отдельный пункт ниже.
4. `config` - директория, отвечающая за конфигурирование битрикс-приложения. Все файлы в ней подключатся еще ДО `init.php`. Изучите их. Используется `arrilot/dotenv-php`
5. `install` - системная директория для первоначальной установки. При разработке не нужна.
6. `logs` - место куда должны попадать *все* файлы с логами приложения.
7. `vendor` - хранилище пакетов composer. Менять там ничего руками нельзя, можно только при желании смотреть

### Директория app

В данной директории лежит бизнес-логика приложения ,а следовательно работа в основном происходит именно тут.

Рассмотрим что внутри
1. `autoload` - папка из которой происходит автозагрузка классов согласно стандарту PSR-4. Классы должны добавляться только сюда, вручную подключаться где-нибудь в `init.php` они не должны. Все они находятся в `namespace App`.
2. `cron` - расписания заданий cron на `lavary/crunz` (описывается в отдельном разделе)
3. `local` - симлинк на обычный Битриксовый local в котором лежат компоненты, шаблоны сайта и т д
4. `views` - вспомогательная директория, читай `README.md` внутри неё
5. `api.php` - API-приложение. Здесь регистрируются все роуты для API и AJAX
6. `console.php` - Консольное приложение. Здесь регистрируются все консольные команды. Они потом могут вызываться либо по крону через `crunz`, либо вручную через php `bxcli`

### Файлы в корне проекта (те которые нуждаются в комментариях)

1. `bxcli` - входная точка консольного приложения. Запускается - ```php bxcli``` из корня проекта.
2. `Envoy.blade.php` - деплоймент скрипт для `laravel/envoy`.
3. `crunz.yml` - конфиг от `lavary/crunz`.

## Зависимости composer

Перед началом работы со Скелетоном нужно посмотреть все пакеты в [(composer.json)](https://gitlab.com/greensight/bitrix-skeleton/blob/master/install/src/composer.json) и убедиться что вы знаете что каждая из них делает.
У каждого из них есть документация (обычно в README на github).

## Структура init.php

`init.php` можно найти в `app/local/php_interface`. В нём лишь подключается ряд вспомагательных библиотек и файлов.
Пройдитесь по этим файлам и прочтите что каждый из них делает.

## Компоненты и шаблоны

### Наименования

В скелете уже создан шаблон сайта `templates/main` и пространство имён для компонентов `components/main`
Свои компоненты следует добавлять в либо в `main` либо создав еще одно простраство для большого "модуля" сайта.
Например если в проекте делается небитриксовая админка, то компоненты для неё можно поместить в пространство имён `admin`.
Личный кабинет - `lk` и т д. Пространства имён с названием компании (`greensight`, `aero` и.т.д) создавать *запрещено*

### Правила разработки своих компонентов

1. Шаблоны компонентов должны быть реализованы на шаблонизаторе `blade` (почитать можно [тут](https://github.com/arrilot/laravel-widgets) и [тут](https://laravel.com/docs/master/blade))
2. Код компонента не должен быть скопирован из кода битриксового компонента. Компонент должен писаться с нуля. 
Исключение - код какого-нибудь компонента восстановления пароля в случае когда очень надо поправить там 1-2 строчки. 
В этом случае место исправления должно быть четко обозначено комментариями
3. В компоненте не должно быть файла `component.php`, везде используется `class.php`. Этот класс должен наследовать `App\Components\BaseComponent`
4. В компоненте за очень редким исключением не должно быть больше 1-2 шаблонов. Шаблоны представляют одни и теже данные с разных углов, с разной версткой.
Если шаблоны у вас логически получаются разные - вам нужны отдельные компоненты.
5. В компоненте не должен использоваться файл `result_modifier.php`. Если очень нужна логика "только для одного шаблона" - нужно создавать отдельный компонент.
6. `class.php` компонентов полученных из-за пунктов 4 и 5 не должны представлять из себя сотни строк копипасты. Если в нескольких компонентах требуются одинаковые методы,
то нужно создать класс-родитель в `App\Components` и унаследовать от него эти компоненты.

### Заготовки компонентов

Для упрощения создания нового компонента в скелетоне есть заготовоки компонентов лежащие в `app/autoload/Components/stubs/new` и в`app/autoload/Components/stubs/ready`.
В папке `new` лежат разные вариации пустых компонентов. В папке `ready` лежат уже готовые компоненты которые *МОГУТ* понадобиться при разработке.
Компоненты из этих директорий сами никогда не подключаются на сайт.
Новый компонент создается копированием одного из этих компонентов в `app/local/components/<пространство_имен>` и после этого его можно разрабатывать или использовать если он уже готов.
Конечно компоненты можно создавать и любым другим удобным для вас образом.

## Модели

Работа с БД в Битриксе не отличается изяществом и удобством, поэтому её имеет смысл построить через дополнительный слой абстракций-моделей.
На низком уровне в данном контексте под моделью понимается класс наследуемый от базовый классов моделей из пакета `arrilot/bitrix-models`.
Все модели следует создавать в `app/autoload/Models`.

Модели - одна из важнейших составляющих скелетона.
Подробная документация по пакету `arrilot/bitrix-models` [тут](https://github.com/arrilot/bitrix-models) 

## API и AJAX

### API

В скелетоне присутсвует заготовка для создания полноценного web api.
Входная точка - файл `/public/api/index.php`.
Веб-сервер должен быть настроен таким образом чтобы все запросы `/api/*` перенаправлялись на него [(пример)](https://gitlab.com/greensight/bitrix-skeleton/blob/master/install/examples/stage_nginx.conf)
API построено на базе микрофреймворка (slim)[https://www.slimframework.com/] и небольшой обёртки над ним - [](https://github.com/arrilot/slim-api-controller)

В самой публичной части ничего трогать не нужно. Регистрация новых роутов происходит в `app/api.php`
Каждый роут указывает на какой-либо метод какого-то контроллера расположенного в `app/autoload/Api` и наследующего `BaseController` расположенный в этой же директории.
АПИ должно поддерживать версионность. Сначала все роуты строятся от `api/v1`, потом при необходимости переходим к `api/v2` и т д.
В остальном вы вольны строить API такое какое вам нужно. Хотите REST, хотите нет.

### AJAX

В философии скелетона AJAX - часть API сайт для внутреннего использования.
Все АJAX роуты строятся начиная от `api/internal`. 
Например, для получения корзины пользователя можно сделать роут
```$this->get('/basket', 'App\Api\Internal\BasketController:index');```
в группе `internal` и потом запрашивать его по урлу `/api/internal/basket`

Также из коробки есть удобный роут `$this->any('/component/{name}[/{template}]', 'App\Api\Internal\ComponentController:show');` который позволяет динамически подключать любые компоненты
Например, `/api/internal/main:basket/mini`. 
Единственное в целях безопасности компонент неоьходимо предварительно добавить в белый список расположенный в классе-контроллере `App\Api\Internal\ComponentController`

## Консольные команды

Все консольные команды реализуются на базе пакета [(symfony/console)](http://symfony.com/doc/current/components/console.html)
Каждая команда - класс в директории `app/autoload/Console`
Несколько команд для примера там уже есть.
Сразу после добавления класса, команду можно использовать -  `php bxcli <имя команды>`
Имя консольной команды имеет формат `namespace:name`.
Например, если у вас есть несколько выгрузок каталога для внешних систем вы можете объединить их все в пространство имен feed
`feeds:yandex`, `feeds:admitad`, `feeds:shoppilot` и разместить классы для этих команд в `app/autoload/Console/Feeds`
Посмотреть все доступные команды можно набрав `php bxcli`

## Периодические задания (cron)

Периодически задания реализованы на базе пакета [(lavary/crunz)](https://github.com/lavary/crunz)
Расписания указываются в `cron\CommonTasks.php`, несколько примеров там уже есть.
На боевом в crontab добавляем лишь одну запись * * * * * /path/to/project/vendor/bin/crunz schedule:run
Подробности читайте в документации `lavary/crunz`

## Git hooks

В разработке используется некоторое количество хуков гита, которые призваны автоматизировать некоторые процессы, упростив таким образом жизнь разработчику и улучшив качество получаемого продукта.
Если вы не знаете что такое Git Hook, то почитать можно [(здесь)](https://git-scm.com/book/ru/v1/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-Git-%D0%9F%D0%B5%D1%80%D0%B5%D1%85%D0%B2%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%B8-%D0%B2-Git)
Хуки устанавливаются при развороте Скелетона, так что не смотря на то что они не находятся под контролем версий заботиться вам об их установке в большинстве случае не нужно.

Полный список хуков:

1. install_dependencies - установка нужных версий зависимостей composer при переключении ветки или пуле.
2. php-linter - проверка синтаксиса php файлов коммита выполняемая перед каждым коммитом. При обнаружении ошибок коммит отменяется.
3. composer-validate - валидация `composer.json` и `composer.lock` перед каждым коммитом. При обнаружении ошибок коммит отменяется.
4. check-merge-conflicts - проверка наличия строк `<<<<<<<`, `=======`,`>>>>>>>` в файлах коммита. Если они найдены, то коммит признается сломанным и нужно править конфликты перед новой попыткой.
5. (не включено по-умолчанию) php-cs-fixer - автоматическое применение код стайла для php файлов коммита при каждом коммите. Необходимо чтобы в системе был установлен https://github.com/FriendsOfPHP/PHP-CS-Fixer и доступен в консоли по имени `php-cs-fixer`. Конфиг код-стайла лежит в файле .php_cs в корне проекта

## Дополнительные страницы в /bitrix/admin/

Для добавления страниц в /bitrix/admin/ в скелетоне есть:
1. Механизм публикации страниц в /bitrix/admin/ (подробнее можно почитать в файле `app/admin.php`)
2. Заготовка под отдельное глобальное меню в Битриксовой админке. Включается в `local/php_interface/handlers.php`

## Фронтэнд

Где лежит фронтэнд сборка описано в "Структура скелета -> Поддиректории -> 2".
Production сборка собирается в `public/assets/build`. Ничего в Битриксовый шаблон сайта собирать не нужно.

Есть возможность включить dev-сборку на проинтегрированном сайте добавив в get-параметр `frontend_build=dev` или просто нажав на соответсвующую кнопку в верхней панели Битрикса.
На боевом также есть возможность через эту же панель сбросить клиентский кэш там, где это возможно.
Чтобы всё это работало скрипты, стили и картинки из сборки надо подключать не захаркдив пути, а через специальные методы.
Например,
1. Вместо `<link href="/assets/build/css/internal.css?v=<?= VERSION ?>" rel="stylesheet">`
подключаем `<link href="<?= frontend()->css('internal.css') ?>" rel="stylesheet">`
2. Вместо `<script src="/assets/build/js/external.js?v=<?= VERSION ?>"></script>" rel="stylesheet">`
подключаем `<script src="<?= frontend()->js('external.js') ?>"></script>`

Есть аналогичные методы `->img()` и `->svg()`, но они в не добавляют константу версии по умолчанию.
